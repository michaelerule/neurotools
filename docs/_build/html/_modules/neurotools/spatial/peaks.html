<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>neurotools.spatial.peaks &mdash; Neurotools 2 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Neurotools
              <img src="../../../_static/logo1.svg" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Subpackages:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.signal.html">signal</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.stats.html">stats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.spatial.html">spatial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.spikes.html">spikes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.graphics.html">graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.linalg.html">linalg</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.jobs.html">jobs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../neurotools.jobs.html">util</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Neurotools</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">neurotools.spatial.peaks</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for neurotools.spatial.peaks</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1"># -*- coding: UTF-8 -*-</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">nested_scopes</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">generators</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">fft</span>


<div class="viewcode-block" id="blurkernel"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.blurkernel">[docs]</a><span class="k">def</span> <span class="nf">blurkernel</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">σ</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    1D Gaussian blur convolution kernel    </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    L: int</span>
<span class="sd">        Size of L×L spatial domain</span>
<span class="sd">    σ: positive float</span>
<span class="sd">        kernel radius exp(-x²/σ) (standard deviation in x </span>
<span class="sd">        and y ×⎷2)</span>
<span class="sd">    normalize: boolean</span>
<span class="sd">        Whether to make kernel sum to 1</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">L</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">L</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">σ</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span> 
        <span class="n">k</span> <span class="o">/=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">k</span><span class="p">)</span></div>

<div class="viewcode-block" id="blurkernel2D"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.blurkernel2D">[docs]</a><span class="k">def</span> <span class="nf">blurkernel2D</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">σ</span><span class="p">,</span><span class="n">normalize</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    2D Gaussian blur convolution kernel    </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    L: int</span>
<span class="sd">        Size of L×L spatial domain</span>
<span class="sd">    σ: positive number</span>
<span class="sd">        kernel radius exp(-x²/σ) </span>
<span class="sd">        (standard deviation in x and y ×⎷2)</span>
<span class="sd">    normalize: boolean; default False</span>
<span class="sd">        whether to make kernel sum to 1</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">blurkernel</span><span class="p">(</span><span class="n">L</span><span class="p">,</span><span class="n">σ</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span> 
        <span class="n">k</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">k</span></div>

<div class="viewcode-block" id="conv"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.conv">[docs]</a><span class="k">def</span> <span class="nf">conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">K</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Compute circular 2D convolution using FFT</span>
<span class="sd">    Kernel K should already be fourier-transformed</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: 2D array</span>
<span class="sd">    K: Fourier-transformed convolution kernel</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span><span class="o">*</span><span class="n">K</span><span class="p">)</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="blur"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.blur">[docs]</a><span class="k">def</span> <span class="nf">blur</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">σ</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    2D Gaussian blur via fft</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: 2D np.array</span>
<span class="sd">    σ: float</span>
<span class="sd">        kernel radius exp(-x²/σ) </span>
<span class="sd">        (standard deviation in x and y ×⎷2)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">kern</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">blurkernel</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">σ</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">kern</span><span class="p">,</span><span class="n">kern</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="findpeaks"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.findpeaks">[docs]</a><span class="k">def</span> <span class="nf">findpeaks</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">height_threshold</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find points higher than height_threshold, that are also </span>
<span class="sd">    higher than all other points in a radius r circular</span>
<span class="sd">    neighborhood.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: np.float32</span>
<span class="sd">        2D array of potential values</span>
<span class="sd">        </span>
<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    height_threshold: float</span>
<span class="sd">        Peaks must be higher than this to cound.</span>
<span class="sd">    r: int</span>
<span class="sd">        Peaks must be larger than all other pixels in radius</span>
<span class="sd">        `r` to count.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.bool</span>
<span class="sd">        2D boolean array of the same sape as q, indicating</span>
<span class="sd">        which pixels are local maxima within radius `r`.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">q</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">L</span>  <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">D</span>  <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r</span>
    
    <span class="c1"># Add padding</span>
    <span class="n">Lpad</span> <span class="o">=</span> <span class="n">L</span><span class="o">+</span><span class="n">D</span><span class="p">;</span>
    <span class="n">qpad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Lpad</span><span class="p">,</span><span class="n">Lpad</span><span class="p">)</span><span class="o">+</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span><span class="n">dtype</span><span class="o">=</span><span class="n">q</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">qpad</span><span class="p">[</span><span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="p">:</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,:,</span><span class="o">...</span><span class="p">]</span>

    <span class="c1"># Points to search</span>
    <span class="n">Δ</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">r</span><span class="p">,</span><span class="n">r</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">r</span>
    <span class="n">search</span> <span class="o">=</span> <span class="p">{(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> 
              <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Δ</span> 
              <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">Δ</span> 
              <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">j</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">j</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">limit</span><span class="p">}</span>
    
    <span class="c1"># Only points above the threshold are candidate peaks</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">q</span><span class="o">&gt;</span><span class="n">height_threshold</span>
    
    <span class="c1"># Mask away points that have a taller neighbor</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">&amp;=</span> <span class="n">q</span><span class="o">&gt;</span><span class="n">qpad</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">r</span><span class="p">:</span><span class="n">L</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">r</span><span class="p">:</span><span class="n">L</span><span class="o">+</span><span class="n">j</span><span class="o">+</span><span class="n">r</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="dx_op"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.dx_op">[docs]</a><span class="k">def</span> <span class="nf">dx_op</span><span class="p">(</span><span class="n">L</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    L: int</span>
<span class="sd">        Size of L×L spatial grid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># 2D difference operator in the 1st coordinate</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">L</span><span class="p">,</span><span class="n">L</span><span class="p">))</span>
    <span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">=-</span><span class="mf">.5</span>
    <span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span> <span class="mf">.5</span>
    <span class="k">return</span> <span class="n">dx</span></div>

<div class="viewcode-block" id="hessian_2D"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.hessian_2D">[docs]</a><span class="k">def</span> <span class="nf">hessian_2D</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Get Hessian of discrete 2D function at all points</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q: np.complex64</span>
<span class="sd">        List of peak locations encoded as x+iy complex</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">q</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">dx</span>  <span class="o">=</span> <span class="n">dx_op</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">f1</span>  <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">f2</span>  <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">dx</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="n">d11</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">f1</span><span class="o">*</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">d12</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">f2</span><span class="o">*</span><span class="n">f1</span><span class="p">)</span>
    <span class="n">d22</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">f2</span><span class="o">*</span><span class="n">f2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">d11</span><span class="p">,</span><span class="n">d12</span><span class="p">],[</span><span class="n">d12</span><span class="p">,</span><span class="n">d22</span><span class="p">]])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="circle_mask"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.circle_mask">[docs]</a><span class="k">def</span> <span class="nf">circle_mask</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span><span class="n">nc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Zeros out corner frequencies</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nr: int</span>
<span class="sd">        number of rows in mask</span>
<span class="sd">    nc: int</span>
<span class="sd">        number of columns in mask</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nr</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">nr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">nr</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nc</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">nc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">nc</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">&lt;</span><span class="mf">.5</span></div>

<div class="viewcode-block" id="fft_upsample_2D"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.fft_upsample_2D">[docs]</a><span class="k">def</span> <span class="nf">fft_upsample_2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">factor</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Upsample 2D array using the FFT</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: 2D np.float32</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,)</span><span class="o">+</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">nl</span><span class="p">,</span><span class="n">nr</span><span class="p">,</span><span class="n">nc</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">*</span><span class="n">circle_mask</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span><span class="n">nc</span><span class="p">)</span>
    <span class="n">nr2</span><span class="p">,</span><span class="n">nc2</span> <span class="o">=</span> <span class="n">nr</span><span class="o">*</span><span class="n">factor</span><span class="p">,</span><span class="n">nc</span><span class="o">*</span><span class="n">factor</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nl</span><span class="p">,</span><span class="n">nr2</span><span class="p">,</span><span class="n">nc2</span><span class="p">)))</span>
    <span class="n">r0</span> <span class="o">=</span> <span class="p">(</span><span class="n">nr2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">nr</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="p">(</span><span class="n">nc2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">nc</span><span class="o">+</span><span class="mi">0</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">f2</span><span class="p">[:,</span><span class="n">r0</span><span class="p">:</span><span class="n">r0</span><span class="o">+</span><span class="n">nr</span><span class="p">,</span><span class="n">c0</span><span class="p">:</span><span class="n">c0</span><span class="o">+</span><span class="n">nc</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span><span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">))))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span><span class="o">*</span><span class="n">factor</span><span class="o">**</span><span class="mi">2</span></div>

<div class="viewcode-block" id="interpolate_peaks"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.interpolate_peaks">[docs]</a><span class="k">def</span> <span class="nf">interpolate_peaks</span><span class="p">(</span>
    <span class="n">z</span><span class="p">,</span>
    <span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">return_coordinates</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span>
    <span class="n">height_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Obtain peak locations by quadratic interpolation.</span>
<span class="sd">    </span>
<span class="sd">    Presently, this function expects a square array. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z: ndarray, L×L×NSAMPLES</span>
<span class="sd">        A 3D array of sampled 2D grid-fields,</span>
<span class="sd">        where the LAST axis is the sample numer. </span>
<span class="sd">        </span>
<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    r: positive int; default 1</span>
<span class="sd">        Radius over which point must be local maximum to </span>
<span class="sd">        include. </span>
<span class="sd">        Defaults to 1 (nearest neighbors)</span>
<span class="sd">    return_coordinates: str; deftault &#39;index&#39;</span>
<span class="sd">        Can be &#39;index&#39; or &#39;normalized&#39;. </span>
<span class="sd">        If &#39;index&#39;, points will be returns in units of </span>
<span class="sd">        array index.</span>
<span class="sd">        If &#39;normalized&#39;, points will be returned in </span>
<span class="sd">        units [0,1]².</span>
<span class="sd">    height_threshold: float</span>
<span class="sd">        Threshold (in height) for peak inclusion. </span>
<span class="sd">        Defaults to the 25th percentil of z</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ix: interpolated x location of peaks</span>
<span class="sd">    iy: interpolated y location of peaks</span>
<span class="sd">    rz: indecies of which sample each peak comes from</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">Lx</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">Ly</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">is3d</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Lx</span><span class="p">,</span><span class="n">Ly</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">is3d</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">height_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">height_threshold</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="mi">25</span><span class="p">)</span>
    
    <span class="c1"># Peaks are defined as local maxima that are larger than all other</span>
    <span class="c1"># points within radius `r`, and also higher than the bottom 25% of</span>
    <span class="c1"># log-rate values. </span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">findpeaks</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">height_threshold</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
    <span class="c1"># Local indecies of local maxima</span>
    <span class="n">rx</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">rz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
    <span class="c1"># Use quadratic interpolation to localize peaks</span>
    <span class="n">clipx</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Lx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">clipy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">Ly</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rx0</span> <span class="o">=</span> <span class="n">clipx</span><span class="p">(</span><span class="n">rx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">rx2</span> <span class="o">=</span> <span class="n">clipx</span><span class="p">(</span><span class="n">rx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ry0</span> <span class="o">=</span> <span class="n">clipy</span><span class="p">(</span><span class="n">ry</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ry2</span> <span class="o">=</span> <span class="n">clipy</span><span class="p">(</span><span class="n">ry</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">s00</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx0</span><span class="p">,</span><span class="n">ry0</span><span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s01</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx0</span><span class="p">,</span><span class="n">ry</span> <span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s02</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx0</span><span class="p">,</span><span class="n">ry2</span><span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s10</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx</span> <span class="p">,</span><span class="n">ry0</span><span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s11</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx</span> <span class="p">,</span><span class="n">ry</span> <span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s12</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx</span> <span class="p">,</span><span class="n">ry2</span><span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s20</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx2</span><span class="p">,</span><span class="n">ry0</span><span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s21</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx2</span><span class="p">,</span><span class="n">ry</span> <span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">s22</span> <span class="o">=</span> <span class="n">z</span><span class="p">[</span><span class="n">rx2</span><span class="p">,</span><span class="n">ry2</span><span class="p">,</span><span class="n">rz</span><span class="p">]</span>
    <span class="n">dx</span>  <span class="o">=</span> <span class="p">(</span><span class="n">s21</span> <span class="o">-</span> <span class="n">s01</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dy</span>  <span class="o">=</span> <span class="p">(</span><span class="n">s12</span> <span class="o">-</span> <span class="n">s10</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">dxx</span> <span class="o">=</span> <span class="n">s21</span><span class="o">+</span><span class="n">s01</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">s11</span>
    <span class="n">dyy</span> <span class="o">=</span> <span class="n">s12</span><span class="o">+</span><span class="n">s10</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">s11</span>
    <span class="n">dxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">s22</span><span class="o">+</span><span class="n">s00</span><span class="o">-</span><span class="n">s20</span><span class="o">-</span><span class="n">s02</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span>
    <span class="n">det</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">dxx</span><span class="o">*</span><span class="n">dyy</span><span class="o">-</span><span class="n">dxy</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span>
    <span class="n">ix</span>  <span class="o">=</span> <span class="p">(</span><span class="n">rx</span><span class="o">-</span><span class="p">(</span> <span class="n">dx</span><span class="o">*</span><span class="n">dyy</span><span class="o">-</span><span class="n">dy</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span><span class="o">*</span><span class="n">det</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="n">iy</span>  <span class="o">=</span> <span class="p">(</span><span class="n">ry</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="n">dx</span><span class="o">*</span><span class="n">dxy</span><span class="o">+</span><span class="n">dy</span><span class="o">*</span><span class="n">dxx</span><span class="p">)</span><span class="o">*</span><span class="n">det</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># Rarely, ill-conditioning leads to inappropriate interpolation</span>
    <span class="c1"># We remove these cases. </span>
    <span class="n">bad</span> <span class="o">=</span> <span class="p">(</span><span class="n">ix</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ix</span><span class="o">&gt;</span><span class="n">Lx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">iy</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">iy</span><span class="o">&gt;</span><span class="n">Ly</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ix</span>  <span class="o">=</span> <span class="n">ix</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>
    <span class="n">iy</span>  <span class="o">=</span> <span class="n">iy</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">return_coordinates</span><span class="o">==</span><span class="s1">&#39;normalized&#39;</span><span class="p">:</span>
        <span class="n">ix</span> <span class="o">/=</span> <span class="n">Lx</span>
        <span class="n">iy</span> <span class="o">/=</span> <span class="n">Ly</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">((</span><span class="n">iy</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">rz</span><span class="p">[</span><span class="o">~</span><span class="n">bad</span><span class="p">])</span> <span class="k">if</span> <span class="n">is3d</span> <span class="k">else</span> <span class="p">(</span><span class="n">iy</span><span class="p">,</span><span class="n">ix</span><span class="p">))</span></div>

<div class="viewcode-block" id="bin_spikes"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.bin_spikes">[docs]</a><span class="k">def</span> <span class="nf">bin_spikes</span><span class="p">(</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bin spikes, using linear interpolation to distribute </span>
<span class="sd">    point mass to four nearest pixels, weighted by distance. </span>
<span class="sd">    </span>
<span class="sd">    Parameters:</span>
<span class="sd">        px (np.flaot32): x location of points</span>
<span class="sd">        py (np.float32): y location of points</span>
<span class="sd">        s (np.array): spike count at each point</span>
<span class="sd">        L (int): number of spatial bins for the LxL grid</span>
<span class="sd">        w (np.float32): weights to apply to each point </span>
<span class="sd">            (default is None for no weigting)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Bin spike counts simple version</span>
    <span class="c1">#N=histogram2d(y,x,(bins,bins),density=0,weights=w)[0]</span>
    <span class="c1">#ws=s if w is None else array(s)*array(w)</span>
    <span class="c1">#K=histogram2d(y,x,(bins,bins),density=0,weights=ws)[0]</span>
    <span class="c1">#return N,K</span>
    
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">px</span><span class="p">))</span>
        
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">px</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">py</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span> \
        <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">px</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">py</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span>
    <span class="n">ix</span><span class="p">,</span><span class="n">fx</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">px</span><span class="o">*</span><span class="n">L</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">iy</span><span class="p">,</span><span class="n">fy</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">py</span><span class="o">*</span><span class="n">L</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span><span class="o">&lt;</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">iy</span><span class="o">&lt;</span><span class="n">L</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">w11</span> <span class="o">=</span> <span class="n">fx</span><span class="o">*</span><span class="n">fy</span><span class="o">*</span><span class="n">w</span>
    <span class="n">w10</span> <span class="o">=</span> <span class="n">fx</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fy</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
    <span class="n">w01</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fx</span><span class="p">)</span><span class="o">*</span><span class="n">fy</span><span class="o">*</span><span class="n">w</span>
    <span class="n">w00</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fy</span><span class="p">)</span><span class="o">*</span><span class="n">w</span>
    
    <span class="n">qx</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">ix</span><span class="p">,</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">ix</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">qy</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">iy</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">iy</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">z</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">w00</span><span class="p">,</span><span class="n">w10</span><span class="p">,</span><span class="n">w01</span><span class="p">,</span><span class="n">w11</span><span class="p">])</span>
    
    <span class="n">ibins</span> <span class="o">=</span> <span class="n">arange</span><span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">N</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">qy</span><span class="p">,</span><span class="n">qx</span><span class="p">,(</span><span class="n">ibins</span><span class="p">,</span><span class="n">ibins</span><span class="p">),</span>
                      <span class="n">density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">z</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ws</span>  <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">concatenate</span><span class="p">((</span><span class="n">s</span><span class="p">,)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">K</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">qy</span><span class="p">,</span><span class="n">qx</span><span class="p">,(</span><span class="n">ibins</span><span class="p">,</span><span class="n">ibins</span><span class="p">),</span>
                      <span class="n">density</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="n">ws</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">N</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">K</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_peak_density"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.get_peak_density">[docs]</a><span class="k">def</span> <span class="nf">get_peak_density</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="n">resolution</span><span class="p">,</span><span class="n">r</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">height_threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Obtain peaks by quadratic interpolation, then bin</span>
<span class="sd">    the results to a spatial grid with linear interpolation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    z: ndarray, L×L×NSAMPLES</span>
<span class="sd">        A 3D array of 2D grid field samples,</span>
<span class="sd">        where the LAST axis is the sample numer. </span>
<span class="sd">    resolution: int&gt;1</span>
<span class="sd">        Upsampling factor for binned peal locations</span>
<span class="sd">        </span>
<span class="sd">    Other Parameters</span>
<span class="sd">    ----------------</span>
<span class="sd">    r: integer</span>
<span class="sd">        Radius over which point must be local maximum to </span>
<span class="sd">        include. </span>
<span class="sd">        Defaults to 1.</span>
<span class="sd">    height_threshold: float</span>
<span class="sd">        Threshold (in height) for peak inclusion. </span>
<span class="sd">        Defaults to the 25th percentil of z</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">L</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1"># Get list of peak locations</span>
    <span class="n">iy</span><span class="p">,</span><span class="n">ix</span> <span class="o">=</span> <span class="n">interpolate_peaks</span><span class="p">(</span><span class="n">z</span><span class="p">,</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">,</span>
        <span class="n">height_threshold</span><span class="o">=</span><span class="n">height_threshold</span><span class="p">)[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="c1"># Bin peaks on a (possibly finer) spatial grid with</span>
    <span class="c1"># linear interpolation. </span>
    <span class="k">return</span> <span class="n">bin_spikes</span><span class="p">(</span><span class="n">iy</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="mi">0</span><span class="o">*</span><span class="n">iy</span><span class="p">,</span><span class="n">L</span><span class="o">*</span><span class="n">resolution</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="brute_force_local_2d_maxima"><a class="viewcode-back" href="../../../neurotools.spatial.peaks.html#neurotools.spatial.peaks.brute_force_local_2d_maxima">[docs]</a><span class="k">def</span> <span class="nf">brute_force_local_2d_maxima</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">R</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Find points higher than all neighbors within </span>
<span class="sd">    radius r in a 2D array. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: 2D np.array; </span>
<span class="sd">    Signal in which to locate local maxima.</span>
<span class="sd">    R: int; </span>
<span class="sd">        RxR region in which a peak must be a local maxima to </span>
<span class="sd">        be included.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (x,y): tuple of np.int32 arrays with peak coordinates.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">R</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">R</span><span class="p">))</span>
    <span class="n">pad</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">R</span>
    <span class="n">x</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">h</span><span class="p">,</span><span class="n">w</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span>
    
    <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">h</span><span class="o">+</span><span class="n">pad</span><span class="p">,</span><span class="n">w</span><span class="o">+</span><span class="n">pad</span><span class="p">))</span>
    <span class="n">padded</span><span class="p">[</span><span class="n">R</span><span class="p">:</span><span class="o">-</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="p">:</span><span class="o">-</span><span class="n">R</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    
    <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">RR</span> <span class="o">=</span> <span class="n">R</span><span class="o">*</span><span class="n">R</span>
    <span class="k">for</span> <span class="n">dr</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">dc</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">R</span><span class="p">,</span><span class="n">R</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dr</span><span class="o">==</span><span class="n">dc</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="n">dr</span><span class="o">*</span><span class="n">dr</span><span class="o">+</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="o">&gt;</span><span class="n">RR</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">best</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                <span class="n">best</span><span class="p">,</span> 
                <span class="n">padded</span><span class="p">[</span><span class="n">R</span><span class="o">+</span><span class="n">dr</span><span class="p">:</span><span class="n">R</span><span class="o">+</span><span class="n">dr</span><span class="o">+</span><span class="n">h</span><span class="p">,</span><span class="n">R</span><span class="o">+</span><span class="n">dc</span><span class="p">:</span><span class="n">R</span><span class="o">+</span><span class="n">dc</span><span class="o">+</span><span class="n">w</span><span class="p">])</span>
    
    <span class="n">ispeak</span> <span class="o">=</span> <span class="n">x</span><span class="o">&gt;=</span><span class="n">best</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ispeak</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017, M Rule.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>